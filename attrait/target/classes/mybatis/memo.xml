<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="memo"> <!-- ibatis에서 sqlMap자리가 mapper로 변경 -->
	
	<select id="replyRead" resultType="MemoDTO" parameterType="int">
	select memono, title, grpno, indent, ansnum
	from memo                          
	where memono = #{memono}                      
	</select>
	
	<update id="upAnsnum" parameterType="Map">
	update memo
	set ansnum = ansnum + 1
	where grpno = #{grpno} and ansnum > #{ansnum}
	</update>
	
	<insert id="replyCreate" parameterType="MemoDTO">
	insert into memo(memono, title, content, wdate, grpno, indent, ansnum, refnum)
	values(memo_seq.nextval, #{title}, #{content}, sysdate, #{grpno}, #{indent}+1, #{ansnum}+1, #{memono} )                       
	</insert>

	<update id="upViewcnt" parameterType="int">
		update memo
		set
		viewcnt = viewcnt + 1
		where memono = #{memono}
	</update>

	<select id="refnumCheck" resultType="int" parameterType="int">
		select count(*) from memo
		where refnum = #{memono}
	</select>

	<delete id="delete" parameterType="int">
		delete from memo
		where memono = #{memono}
	</delete>
	
	<update id="update" parameterType="MemoDTO">
		update memo           
		set 
		title = #{title},
		content = #{content}
		where memono = #{memono}      
	</update>

	<insert id="create" parameterType="MemoDTO"> <!-- select키를 사용하지 않아도  리턴해줌 -->
		insert into memo(memono, title, content, wdate, grpno)
		values(memo_seq.nextval, #{title}, #{content}, sysdate,            
		(select nvl(max(grpno),0)+1 from memo))
	</insert>

	<!-- read는 하나의 레코드만 가져오면되기때문에 DTO를 가져옴  , PK가 int임-->
	<!-- to_char 데이터타입을 캐릭터 타입으로 변환 -->
	<select id="read" resultType="MemoDTO" parameterType="int">
	select memono, title, content,
	date_format(wdate, '%Y-%m-%d')as wdate, viewcnt
	from memo
	where memono = #{memono}
	</select>
	
	<select id="list" parameterType="Map" resultType="MemoDTO">
		select memono, title, to_char(wdate,'yyyy-mm-dd') wdate, viewcnt, r 
		from(                                                            
			select memono, title, wdate, viewcnt, rownum r                   
			from(                                                            
				SELECT memono, title, wdate,                                     
				viewcnt FROM memo  
				<where>
				<if test="col=='title'">
					title like '%'||#{word}||'%'
				</if>
				<if test="col=='content'">
					content like '%'||#{word}||'%'
				</if>
				</where>
				ORDER BY memono DESC
				)
			)
			<![CDATA[
			where r >= #{sno} and r <= #{eno} 
			]]>                                             
	</select>

	<!-- resultType는 count값이니깐 int -->
	<select parameterType="Map" resultType="int" id="total">
		select count(*) from memo 
		<where>
			<if test="wname"> wname like '%' || #{word} || '%' </if>
			<if test="title"> title like '%' || #{word} || '%' </if>
			<if test="content"> content like '%' || #{word} || '%' </if>
		</where>
	</select>
</mapper>